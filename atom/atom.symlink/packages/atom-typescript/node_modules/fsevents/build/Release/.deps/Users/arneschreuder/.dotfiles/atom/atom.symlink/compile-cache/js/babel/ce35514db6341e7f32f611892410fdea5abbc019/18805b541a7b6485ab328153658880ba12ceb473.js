Object.defineProperty(exports, '__esModule', {
	value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/** @babel */

var _commandsGenerate = require('./commands/generate');

var _commandsGenerate2 = _interopRequireDefault(_commandsGenerate);

var _commandsShow = require('./commands/show');

var _commandsShow2 = _interopRequireDefault(_commandsShow);

var _commandsFix = require('./commands/fix');

var _commandsFix2 = _interopRequireDefault(_commandsFix);

var lazyReq = require('lazy-req')(require);

var atm = lazyReq('atom');

var statusTile = lazyReq('./lib/statustile-view');
var wrapGuide = lazyReq('./lib/wrapguide-view');
var editorconfig = lazyReq('editorconfig');

var STATES = ['subtle', 'success', 'info', 'warning', 'error'];

// Holds all **blacklisted** packages and the properties we assume are affected by them
// 'packagename': [properties]
var BLACKLISTED_PACKAGES = {
	whitespace: ['insert_final_newline', 'trim_trailing_whitespace']
};

// Sets the state of the embedded editorconfig
// This includes the severity (info, warning..) as well as the notification-messages for users
function setState(ecfg) {
	var messages = [];
	var statcon = 0;

	// Check if any editorconfig-setting is in use
	if (Object.keys(ecfg.settings).reduce(function (prev, curr) {
		return ecfg.settings[curr] !== 'auto' || prev;
	}, false)) {
		statcon = Math.max(statcon, 1);
	}

	// Check the 'Tab Type'-setting
	if (ecfg.settings.indent_style !== 'auto' && atom.config.get('editor.tabType') !== 'auto') {
		var tabType = atom.config.get('editor.tabType');

		messages.push('**Tab Type:** You editor\'s configuration setting "Tab Type"\n\t\t(currently "' + tabType + '" prevents the editorconfig-property `indent_style` from working.\n\t\t@"Tab Type" **must** be set to "auto" to fix this issue.');

		statcon = Math.max(statcon, 4);
	}

	// Check for BLACKLISTED packages
	var suspiciuousPackages = {};
	var affectedProperties = undefined;
	for (var packageName in BLACKLISTED_PACKAGES) {
		if (({}).hasOwnProperty.call(BLACKLISTED_PACKAGES, packageName)) {
			affectedProperties = BLACKLISTED_PACKAGES[packageName].filter(function (prop) {
				return ecfg.settings[prop] !== 'auto';
			});
			if (affectedProperties.length > 0 && atom.packages.isPackageActive(packageName)) {
				suspiciuousPackages[packageName] = affectedProperties;
			}
		}
	}
	if (Object.keys(suspiciuousPackages).length > 0) {
		for (var packageName in suspiciuousPackages) {
			if (({}).hasOwnProperty.call(suspiciuousPackages, packageName)) {
				var properties = suspiciuousPackages[packageName];
				messages.push('**' + packageName + ':** It is likely that the\n\t\t\t\t' + packageName + '-package prevents the following\n\t\t\t\tpropert' + (properties.length > 1 ? 'ies' : 'y') + ' from working reliably:\n\t\t\t\t`' + properties.join('`, `') + '`.@You may deactivate or disable the ' + packageName + '-package\n\t\t\t\tto fix that issue.');
			}
		}
		statcon = Math.max(statcon, 3);
	}

	switch (statcon) {
		case 1:
			messages.push('The editorconfig was applied successfully and the editor for this file\n\t\t\tshould work as expected. If you face any unexpected behavior please report us the issue.\n\t\t\t♥️');
			break;
		case 0:
			messages.push('For this file were no editorconfig-settings applied.');
			break;
		default:
			break;
	}

	// Apply changes
	ecfg.messages = messages;
	ecfg.state = STATES[statcon];
	statusTile().updateIcon(ecfg.state);
}

// Initializes the (into the TextBuffer-instance) embedded editorconfig-object
function initializeTextBuffer(buffer) {
	if ('editorconfig' in buffer === false) {
		buffer.editorconfig = {
			buffer: buffer, // preserving a reference to the parent TextBuffer
			disposables: new (atm().CompositeDisposable)(),
			state: 'subtle',
			settings: {
				trim_trailing_whitespace: 'auto', // eslint-disable-line camelcase
				insert_final_newline: 'auto', // eslint-disable-line camelcase
				max_line_length: 'auto', // eslint-disable-line camelcase
				end_of_line: 'auto', // eslint-disable-line camelcase
				indent_style: 'auto', // eslint-disable-line camelcase
				tab_width: 'auto', // eslint-disable-line camelcase
				charset: 'auto' // eslint-disable-line camelcase
			},

			// Sets the given package active or inactive
			setPackageState: function setPackageState(name, active) {
				if (atom.packages.isPackageDisabled(name) === false && atom.packages.isPackageActive(name) !== active) {
					if (active === true) {
						atom.packages.activatePackage(name);
					} else {
						atom.packages.deactivatePackage(name);
					}
				}
			},

			// Applies the settings to the buffer and the corresponding editor
			applySettings: function applySettings() {
				var editor = atom.workspace.getTextEditors().reduce(function (prev, curr) {
					return curr.getBuffer() === buffer && curr || prev;
				}, undefined);
				if (!editor) {
					return;
				}

				var configOptions = { scope: editor.getRootScopeDescriptor() };
				var settings = this.settings;

				if (editor && editor.getBuffer() === buffer) {
					if (settings.indent_style === 'auto') {
						editor.setSoftTabs(atom.config.get('editor.softTabs', configOptions));
					} else {
						editor.setSoftTabs(settings.indent_style === 'space');
					}

					if (settings.tab_width === 'auto') {
						editor.setTabLength(atom.config.get('editor.tabLength', configOptions));
					} else {
						editor.setTabLength(settings.tab_width);
					}

					if (settings.charset === 'auto') {
						buffer.setEncoding(atom.config.get('core.fileEncoding', configOptions));
					} else {
						buffer.setEncoding(settings.charset);
					}

					// max_line_length-settings
					var editorParams = {};
					if (settings.max_line_length === 'auto') {
						editorParams.softWrapped = atom.config.get('editor.softWrap', configOptions);
						editorParams.softWrapAtPreferredLineLength = atom.config.get('editor.softWrapAtPreferredLineLength', configOptions);
						editorParams.preferredLineLength = atom.config.get('editor.preferredLineLength', configOptions);
					} else {
						editorParams.softWrapped = true;
						editorParams.softWrapAtPreferredLineLength = true;
						editorParams.preferredLineLength = settings.max_line_length;
					}

					// Update the editor-properties
					editor.update(editorParams);

					// Ensure the wrap-guide is set properly
					if (this.wrapGuide === undefined) {
						this.wrapGuide = new (wrapGuide())();
						this.wrapGuide.initialize(editor, atom.views.getView(editor));
					}
					this.wrapGuide.update();
					// Toggle the wrap-guide package if necessary
					this.setPackageState('wrap-guide', this.wrapGuide.isVisible() === false);

					if (settings.end_of_line !== 'auto') {
						buffer.setPreferredLineEnding(settings.end_of_line);
					}
				}
				setState(this);
			},

			// onWillSave-Event-Handler
			// Trims whitespaces and inserts/strips final newline before saving
			onWillSave: function onWillSave() {
				var settings = this.settings;

				if (settings.trim_trailing_whitespace === true) {
					// eslint-disable-next-line max-params
					buffer.backwardsScan(/[ \t]+$/gm, function (params) {
						if (params.match[0].length > 0) {
							params.replace('');
						}
					});
				}

				if (settings.insert_final_newline !== 'auto') {
					var lastRow = buffer.getLineCount() - 1;

					if (buffer.isRowBlank(lastRow)) {
						var stripStart = buffer.previousNonBlankRow(lastRow);

						if (settings.insert_final_newline === true) {
							stripStart += 1;
						}
						// Strip empty lines from the end
						if (stripStart < lastRow) {
							buffer.deleteRows(stripStart + 1, lastRow);
						}
					} else if (settings.insert_final_newline === true) {
						buffer.append('\n');
					}
				}
			}
		};

		buffer.editorconfig.disposables.add(buffer.onWillSave(buffer.editorconfig.onWillSave.bind(buffer.editorconfig)));
		if (buffer.getUri() && buffer.getUri().match(/[\\|/]\.editorconfig$/g) !== null) {
			buffer.editorconfig.disposables.add(buffer.onDidSave(reapplyEditorconfig));
		}
	}
}

// Reveal and apply the editorconfig for the given TextEditor-instance
function observeTextEditor(editor) {
	if (!editor) {
		return;
	}
	initializeTextBuffer(editor.getBuffer());

	var file = editor.getURI();
	if (!file) {
		editor.onDidSave(function () {
			observeTextEditor(editor);
		});
		return;
	}

	editorconfig().parse(file).then(function (config) {
		if (Object.keys(config).length === 0) {
			return;
		}

		var ecfg = editor.getBuffer().editorconfig;
		var settings = ecfg.settings;
		var lineEndings = {
			crlf: '\r\n',
			cr: '\r',
			lf: '\n'
		};

		// Preserve evaluated Editorconfig
		ecfg.config = config;

		// Carefully normalize and initialize config-settings
		// eslint-disable-next-line camelcase
		settings.trim_trailing_whitespace = 'trim_trailing_whitespace' in config && typeof config.trim_trailing_whitespace === 'boolean' ? config.trim_trailing_whitespace === true : 'auto';

		// eslint-disable-next-line camelcase
		settings.insert_final_newline = 'insert_final_newline' in config && typeof config.insert_final_newline === 'boolean' ? config.insert_final_newline === true : 'auto';

		// eslint-disable-next-line camelcase
		settings.indent_style = 'indent_style' in config && config.indent_style.search(/^(space|tab)$/) > -1 ? config.indent_style : 'auto';

		// eslint-disable-next-line camelcase
		settings.end_of_line = lineEndings[config.end_of_line] || 'auto';

		// eslint-disable-next-line camelcase
		settings.tab_width = parseInt(config.indent_size || config.tab_width, 10);
		if (isNaN(settings.tab_width) || settings.tab_width <= 0) {
			settings.tab_width = 'auto'; // eslint-disable-line camelcase
		}

		// eslint-disable-next-line camelcase
		settings.max_line_length = parseInt(config.max_line_length, 10);
		if (isNaN(settings.max_line_length) || settings.max_line_length <= 0) {
			settings.max_line_length = 'auto'; // eslint-disable-line camelcase
		}

		settings.charset = 'charset' in config ? config.charset.replace(/-/g, '').toLowerCase() : 'auto';

		ecfg.applySettings();
	})['catch'](Error, function (e) {
		console.warn('atom-editorconfig: ' + e);
	});
}

// Reapplies the whole editorconfig to **all** open TextEditor-instances
function reapplyEditorconfig() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		observeTextEditor(editor);
	});
}

// Reapplies the settings immediately after changing the focus to a new pane
function observeActivePaneItem(editor) {
	if (editor && editor.constructor.name === 'TextEditor') {
		if (editor.getBuffer().editorconfig) {
			editor.getBuffer().editorconfig.applySettings();
		}
	} else {
		statusTile().removeIcon();
	}
}

// Hook into the events to recognize the user opening new editors or changing the pane
var activate = function activate() {
	(0, _commandsGenerate2['default'])();
	(0, _commandsShow2['default'])();
	(0, _commandsFix2['default'])();
	atom.workspace.observeTextEditors(observeTextEditor);
	atom.workspace.observeActivePaneItem(observeActivePaneItem);
};

// Clean the status-icon up, remove all embedded editorconfig-objects
var deactivate = function deactivate() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		editor.getBuffer().editorconfig.disposables.dispose();
	});
	statusTile().removeIcon();
};

// Apply the statusbar icon-container
// The icon will be applied if needed
var consumeStatusBar = function consumeStatusBar(statusBar) {
	if (statusTile().containerExists() === false) {
		statusBar.addRightTile({
			item: statusTile().createContainer(),
			priority: 999
		});
	}
};

exports['default'] = { activate: activate, deactivate: deactivate, consumeStatusBar: consumeStatusBar };
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hcm5lc2NocmV1ZGVyLy5kb3RmaWxlcy9hdG9tL2F0b20uc3ltbGluay9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvbm9kZV9tb2R1bGVzL2ZzZXZlbnRzL2J1aWxkL1JlbGVhc2UvLmRlcHMvVXNlcnMvYXJuZXNjaHJldWRlci8uZG90ZmlsZXMvYXRvbS9hdG9tLnN5bWxpbmsvcGFja2FnZXMvZWRpdG9yY29uZmlnL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O2dDQUMyQixxQkFBcUI7Ozs7NEJBQzFCLGlCQUFpQjs7OzsyQkFDbkIsZ0JBQWdCOzs7O0FBRXBDLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQzs7QUFFN0MsSUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUU1QixJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUNwRCxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNsRCxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7O0FBRTdDLElBQU0sTUFBTSxHQUFHLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDOzs7O0FBSWpFLElBQU0sb0JBQW9CLEdBQUc7QUFDNUIsV0FBVSxFQUFFLENBQUMsc0JBQXNCLEVBQUUsMEJBQTBCLENBQUM7Q0FDaEUsQ0FBQzs7OztBQUlGLFNBQVMsUUFBUSxDQUFDLElBQUksRUFBRTtBQUN2QixLQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7QUFDcEIsS0FBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDOzs7QUFHaEIsS0FBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFLO0FBQ3JELFNBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxNQUFNLElBQUksSUFBSSxDQUFDO0VBQzlDLEVBQUUsS0FBSyxDQUFDLEVBQUU7QUFDVixTQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7RUFDL0I7OztBQUdELEtBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEtBQUssTUFBTSxJQUN4QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLE1BQU0sRUFBRTtBQUM5QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztBQUVsRCxVQUFRLENBQUMsSUFBSSxvRkFDQyxPQUFPLHFJQUNxQyxDQUFDOztBQUUzRCxTQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7RUFDL0I7OztBQUdELEtBQU0sbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0FBQy9CLEtBQUksa0JBQWtCLFlBQUEsQ0FBQztBQUN2QixNQUFLLElBQU0sV0FBVyxJQUFJLG9CQUFvQixFQUFFO0FBQy9DLE1BQUksQ0FBQSxHQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxXQUFXLENBQUMsRUFBRTtBQUM5RCxxQkFBa0IsR0FBRyxvQkFBb0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJLEVBQUk7QUFDckUsV0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLE1BQU0sQ0FBQztJQUN0QyxDQUFDLENBQUM7QUFDSCxPQUFJLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLElBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxFQUFFO0FBQzVDLHVCQUFtQixDQUFDLFdBQVcsQ0FBQyxHQUFHLGtCQUFrQixDQUFDO0lBQ3REO0dBQ0Q7RUFDRDtBQUNELEtBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDaEQsT0FBSyxJQUFNLFdBQVcsSUFBSSxtQkFBbUIsRUFBRTtBQUM5QyxPQUFJLENBQUEsR0FBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsV0FBVyxDQUFDLEVBQUU7QUFDN0QsUUFBTSxVQUFVLEdBQUcsbUJBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDcEQsWUFBUSxDQUFDLElBQUksUUFBTSxXQUFXLDJDQUM1QixXQUFXLHlEQUNKLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLEtBQUssR0FBRyxHQUFHLENBQUEsMENBQ3hDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLDZDQUF5QyxXQUFXLDBDQUMzRCxDQUFDO0lBQ3JCO0dBQ0Q7QUFDRCxTQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7RUFDL0I7O0FBRUQsU0FBUSxPQUFPO0FBQ2QsT0FBSyxDQUFDO0FBQ0wsV0FBUSxDQUFDLElBQUksb0xBRVQsQ0FBQztBQUNMLFNBQU07QUFBQSxBQUNQLE9BQUssQ0FBQztBQUNMLFdBQVEsQ0FBQyxJQUFJLHdEQUF3RCxDQUFDO0FBQ3RFLFNBQU07QUFBQSxBQUNQO0FBQ0MsU0FBTTtBQUFBLEVBQ1A7OztBQUdELEtBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0FBQ3pCLEtBQUksQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdCLFdBQVUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Q0FDcEM7OztBQUdELFNBQVMsb0JBQW9CLENBQUMsTUFBTSxFQUFFO0FBQ3JDLEtBQUksY0FBYyxJQUFJLE1BQU0sS0FBSyxLQUFLLEVBQUU7QUFDdkMsUUFBTSxDQUFDLFlBQVksR0FBRztBQUNyQixTQUFNLEVBQU4sTUFBTTtBQUNOLGNBQVcsRUFBRSxLQUFLLEdBQUcsRUFBRSxDQUFDLG1CQUFtQixDQUFBLEVBQUc7QUFDOUMsUUFBSyxFQUFFLFFBQVE7QUFDZixXQUFRLEVBQUU7QUFDVCw0QkFBd0IsRUFBRSxNQUFNO0FBQ2hDLHdCQUFvQixFQUFFLE1BQU07QUFDNUIsbUJBQWUsRUFBRSxNQUFNO0FBQ3ZCLGVBQVcsRUFBRSxNQUFNO0FBQ25CLGdCQUFZLEVBQUUsTUFBTTtBQUNwQixhQUFTLEVBQUUsTUFBTTtBQUNqQixXQUFPLEVBQUUsTUFBTTtJQUNmOzs7QUFHRCxrQkFBZSxFQUFBLHlCQUFDLElBQUksRUFBRSxNQUFNLEVBQUU7QUFDN0IsUUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxLQUFLLEtBQUssSUFDbEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssTUFBTSxFQUFFO0FBQ2hELFNBQUksTUFBTSxLQUFLLElBQUksRUFBRTtBQUNwQixVQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztNQUNwQyxNQUFNO0FBQ04sVUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztNQUN0QztLQUNEO0lBQ0Q7OztBQUdELGdCQUFhLEVBQUEseUJBQUc7QUFDZixRQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQUksRUFBRSxJQUFJLEVBQUs7QUFDckUsWUFBTyxBQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFLLElBQUksQ0FBQztLQUNyRCxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ2QsUUFBSSxDQUFDLE1BQU0sRUFBRTtBQUNaLFlBQU87S0FDUDs7QUFFRCxRQUFNLGFBQWEsR0FBRyxFQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsc0JBQXNCLEVBQUUsRUFBQyxDQUFDO0FBQy9ELFFBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7O0FBRS9CLFFBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxNQUFNLEVBQUU7QUFDNUMsU0FBSSxRQUFRLENBQUMsWUFBWSxLQUFLLE1BQU0sRUFBRTtBQUNyQyxZQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7TUFDdEUsTUFBTTtBQUNOLFlBQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksS0FBSyxPQUFPLENBQUMsQ0FBQztNQUN0RDs7QUFFRCxTQUFJLFFBQVEsQ0FBQyxTQUFTLEtBQUssTUFBTSxFQUFFO0FBQ2xDLFlBQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQztNQUN4RSxNQUFNO0FBQ04sWUFBTSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7TUFDeEM7O0FBRUQsU0FBSSxRQUFRLENBQUMsT0FBTyxLQUFLLE1BQU0sRUFBRTtBQUNoQyxZQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7TUFDeEUsTUFBTTtBQUNOLFlBQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO01BQ3JDOzs7QUFHRCxTQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDeEIsU0FBSSxRQUFRLENBQUMsZUFBZSxLQUFLLE1BQU0sRUFBRTtBQUN4QyxrQkFBWSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUM3RSxrQkFBWSxDQUFDLDZCQUE2QixHQUN6QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUN4RSxrQkFBWSxDQUFDLG1CQUFtQixHQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRSxhQUFhLENBQUMsQ0FBQztNQUM5RCxNQUFNO0FBQ04sa0JBQVksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0FBQ2hDLGtCQUFZLENBQUMsNkJBQTZCLEdBQUcsSUFBSSxDQUFDO0FBQ2xELGtCQUFZLENBQUMsbUJBQW1CLEdBQUcsUUFBUSxDQUFDLGVBQWUsQ0FBQztNQUM1RDs7O0FBR0QsV0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQzs7O0FBRzVCLFNBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUU7QUFDakMsVUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLFNBQVMsR0FBRSxFQUFHLENBQUM7QUFDckMsVUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQ3hCLE1BQU0sRUFDTixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FDMUIsQ0FBQztNQUNGO0FBQ0QsU0FBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQzs7QUFFeEIsU0FBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsS0FBSyxLQUFLLENBQUMsQ0FBQzs7QUFFekUsU0FBSSxRQUFRLENBQUMsV0FBVyxLQUFLLE1BQU0sRUFBRTtBQUNwQyxZQUFNLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO01BQ3BEO0tBQ0Q7QUFDRCxZQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDZjs7OztBQUlELGFBQVUsRUFBQSxzQkFBRztBQUNaLFFBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7O0FBRS9CLFFBQUksUUFBUSxDQUFDLHdCQUF3QixLQUFLLElBQUksRUFBRTs7QUFFL0MsV0FBTSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsVUFBQSxNQUFNLEVBQUk7QUFDM0MsVUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDL0IsYUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztPQUNuQjtNQUNELENBQUMsQ0FBQztLQUNIOztBQUVELFFBQUksUUFBUSxDQUFDLG9CQUFvQixLQUFLLE1BQU0sRUFBRTtBQUM3QyxTQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLEdBQUcsQ0FBQyxDQUFDOztBQUUxQyxTQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDL0IsVUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDOztBQUVyRCxVQUFJLFFBQVEsQ0FBQyxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7QUFDM0MsaUJBQVUsSUFBSSxDQUFDLENBQUM7T0FDaEI7O0FBRUQsVUFBSSxVQUFVLEdBQUcsT0FBTyxFQUFFO0FBQ3pCLGFBQU0sQ0FBQyxVQUFVLENBQUMsVUFBVSxHQUFHLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztPQUMzQztNQUNELE1BQU0sSUFBSSxRQUFRLENBQUMsb0JBQW9CLEtBQUssSUFBSSxFQUFFO0FBQ2xELFlBQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7TUFDcEI7S0FDRDtJQUNEO0dBQ0QsQ0FBQzs7QUFFRixRQUFNLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQ2xDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUMzRSxDQUFDO0FBQ0YsTUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLElBQUksRUFBRTtBQUNoRixTQUFNLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQ2xDLE1BQU0sQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FDckMsQ0FBQztHQUNGO0VBQ0Q7Q0FDRDs7O0FBR0QsU0FBUyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUU7QUFDbEMsS0FBSSxDQUFDLE1BQU0sRUFBRTtBQUNaLFNBQU87RUFDUDtBQUNELHFCQUFvQixDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDOztBQUV6QyxLQUFNLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDN0IsS0FBSSxDQUFDLElBQUksRUFBRTtBQUNWLFFBQU0sQ0FBQyxTQUFTLENBQUMsWUFBTTtBQUN0QixvQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztHQUMxQixDQUFDLENBQUM7QUFDSCxTQUFPO0VBQ1A7O0FBRUQsYUFBWSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU0sRUFBSTtBQUN6QyxNQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUNyQyxVQUFPO0dBQ1A7O0FBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLFlBQVksQ0FBQztBQUM3QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQy9CLE1BQU0sV0FBVyxHQUFHO0FBQ25CLE9BQUksRUFBRSxNQUFNO0FBQ1osS0FBRSxFQUFFLElBQUk7QUFDUixLQUFFLEVBQUUsSUFBSTtHQUNSLENBQUM7OztBQUdGLE1BQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDOzs7O0FBSXJCLFVBQVEsQ0FBQyx3QkFBd0IsR0FBRyxBQUFDLDBCQUEwQixJQUFJLE1BQU0sSUFDeEUsT0FBTyxNQUFNLENBQUMsd0JBQXdCLEtBQUssU0FBUyxHQUNwRCxNQUFNLENBQUMsd0JBQXdCLEtBQUssSUFBSSxHQUN4QyxNQUFNLENBQUM7OztBQUdSLFVBQVEsQ0FBQyxvQkFBb0IsR0FBRyxBQUFDLHNCQUFzQixJQUFJLE1BQU0sSUFDaEUsT0FBTyxNQUFNLENBQUMsb0JBQW9CLEtBQUssU0FBUyxHQUNoRCxNQUFNLENBQUMsb0JBQW9CLEtBQUssSUFBSSxHQUNwQyxNQUFNLENBQUM7OztBQUdSLFVBQVEsQ0FBQyxZQUFZLEdBQUcsQUFBQyxBQUFDLGNBQWMsSUFBSSxNQUFNLElBQ2pELE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUNoRCxNQUFNLENBQUMsWUFBWSxHQUNuQixNQUFNLENBQUM7OztBQUdSLFVBQVEsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxNQUFNLENBQUM7OztBQUdqRSxVQUFRLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUUsTUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxTQUFTLElBQUksQ0FBQyxFQUFFO0FBQ3pELFdBQVEsQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDO0dBQzVCOzs7QUFHRCxVQUFRLENBQUMsZUFBZSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ2hFLE1BQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxRQUFRLENBQUMsZUFBZSxJQUFJLENBQUMsRUFBRTtBQUNyRSxXQUFRLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQztHQUNsQzs7QUFFRCxVQUFRLENBQUMsT0FBTyxHQUFHLEFBQUMsU0FBUyxJQUFJLE1BQU0sR0FDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUM5QyxNQUFNLENBQUM7O0FBRVIsTUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0VBQ3JCLENBQUMsU0FBTSxDQUFDLEtBQUssRUFBRSxVQUFBLENBQUMsRUFBSTtBQUNwQixTQUFPLENBQUMsSUFBSSx5QkFBdUIsQ0FBQyxDQUFHLENBQUM7RUFDeEMsQ0FBQyxDQUFDO0NBQ0g7OztBQUdELFNBQVMsbUJBQW1CLEdBQUc7QUFDOUIsS0FBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztBQUNwRCxZQUFXLENBQUMsT0FBTyxDQUFDLFVBQUEsTUFBTSxFQUFJO0FBQzdCLG1CQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0VBQzFCLENBQUMsQ0FBQztDQUNIOzs7QUFHRCxTQUFTLHFCQUFxQixDQUFDLE1BQU0sRUFBRTtBQUN0QyxLQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxZQUFZLEVBQUU7QUFDdkQsTUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsWUFBWSxFQUFFO0FBQ3BDLFNBQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLENBQUM7R0FDaEQ7RUFDRCxNQUFNO0FBQ04sWUFBVSxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7RUFDMUI7Q0FDRDs7O0FBR0QsSUFBTSxRQUFRLEdBQUcsU0FBWCxRQUFRLEdBQVM7QUFDdEIscUNBQWdCLENBQUM7QUFDakIsaUNBQVcsQ0FBQztBQUNaLGdDQUFTLENBQUM7QUFDVixLQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDckQsS0FBSSxDQUFDLFNBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0NBQzVELENBQUM7OztBQUdGLElBQU0sVUFBVSxHQUFHLFNBQWIsVUFBVSxHQUFTO0FBQ3hCLEtBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDcEQsWUFBVyxDQUFDLE9BQU8sQ0FBQyxVQUFBLE1BQU0sRUFBSTtBQUM3QixRQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztFQUN0RCxDQUFDLENBQUM7QUFDSCxXQUFVLEVBQUUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztDQUMxQixDQUFDOzs7O0FBSUYsSUFBTSxnQkFBZ0IsR0FBRyxTQUFuQixnQkFBZ0IsQ0FBRyxTQUFTLEVBQUk7QUFDckMsS0FBSSxVQUFVLEVBQUUsQ0FBQyxlQUFlLEVBQUUsS0FBSyxLQUFLLEVBQUU7QUFDN0MsV0FBUyxDQUFDLFlBQVksQ0FBQztBQUN0QixPQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsZUFBZSxFQUFFO0FBQ3BDLFdBQVEsRUFBRSxHQUFHO0dBQ2IsQ0FBQyxDQUFDO0VBQ0g7Q0FDRCxDQUFDOztxQkFFYSxFQUFDLFFBQVEsRUFBUixRQUFRLEVBQUUsVUFBVSxFQUFWLFVBQVUsRUFBRSxnQkFBZ0IsRUFBaEIsZ0JBQWdCLEVBQUMiLCJmaWxlIjoiL1VzZXJzL2FybmVzY2hyZXVkZXIvLmRvdGZpbGVzL2F0b20vYXRvbS5zeW1saW5rL3BhY2thZ2VzL2F0b20tdHlwZXNjcmlwdC9ub2RlX21vZHVsZXMvZnNldmVudHMvYnVpbGQvUmVsZWFzZS8uZGVwcy9Vc2Vycy9hcm5lc2NocmV1ZGVyLy5kb3RmaWxlcy9hdG9tL2F0b20uc3ltbGluay9wYWNrYWdlcy9lZGl0b3Jjb25maWcvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQGJhYmVsICovXG5pbXBvcnQgZ2VuZXJhdGVDb25maWcgZnJvbSAnLi9jb21tYW5kcy9nZW5lcmF0ZSc7XG5pbXBvcnQgc2hvd1N0YXRlIGZyb20gJy4vY29tbWFuZHMvc2hvdyc7XG5pbXBvcnQgZml4RmlsZSBmcm9tICcuL2NvbW1hbmRzL2ZpeCc7XG5cbmNvbnN0IGxhenlSZXEgPSByZXF1aXJlKCdsYXp5LXJlcScpKHJlcXVpcmUpO1xuXG5jb25zdCBhdG0gPSBsYXp5UmVxKCdhdG9tJyk7XG5cbmNvbnN0IHN0YXR1c1RpbGUgPSBsYXp5UmVxKCcuL2xpYi9zdGF0dXN0aWxlLXZpZXcnKTtcbmNvbnN0IHdyYXBHdWlkZSA9IGxhenlSZXEoJy4vbGliL3dyYXBndWlkZS12aWV3Jyk7XG5jb25zdCBlZGl0b3Jjb25maWcgPSBsYXp5UmVxKCdlZGl0b3Jjb25maWcnKTtcblxuY29uc3QgU1RBVEVTID0gWydzdWJ0bGUnLCAnc3VjY2VzcycsICdpbmZvJywgJ3dhcm5pbmcnLCAnZXJyb3InXTtcblxuLy8gSG9sZHMgYWxsICoqYmxhY2tsaXN0ZWQqKiBwYWNrYWdlcyBhbmQgdGhlIHByb3BlcnRpZXMgd2UgYXNzdW1lIGFyZSBhZmZlY3RlZCBieSB0aGVtXG4vLyAncGFja2FnZW5hbWUnOiBbcHJvcGVydGllc11cbmNvbnN0IEJMQUNLTElTVEVEX1BBQ0tBR0VTID0ge1xuXHR3aGl0ZXNwYWNlOiBbJ2luc2VydF9maW5hbF9uZXdsaW5lJywgJ3RyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZSddXG59O1xuXG4vLyBTZXRzIHRoZSBzdGF0ZSBvZiB0aGUgZW1iZWRkZWQgZWRpdG9yY29uZmlnXG4vLyBUaGlzIGluY2x1ZGVzIHRoZSBzZXZlcml0eSAoaW5mbywgd2FybmluZy4uKSBhcyB3ZWxsIGFzIHRoZSBub3RpZmljYXRpb24tbWVzc2FnZXMgZm9yIHVzZXJzXG5mdW5jdGlvbiBzZXRTdGF0ZShlY2ZnKSB7XG5cdGNvbnN0IG1lc3NhZ2VzID0gW107XG5cdGxldCBzdGF0Y29uID0gMDtcblxuXHQvLyBDaGVjayBpZiBhbnkgZWRpdG9yY29uZmlnLXNldHRpbmcgaXMgaW4gdXNlXG5cdGlmIChPYmplY3Qua2V5cyhlY2ZnLnNldHRpbmdzKS5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IHtcblx0XHRyZXR1cm4gZWNmZy5zZXR0aW5nc1tjdXJyXSAhPT0gJ2F1dG8nIHx8IHByZXY7XG5cdH0sIGZhbHNlKSkge1xuXHRcdHN0YXRjb24gPSBNYXRoLm1heChzdGF0Y29uLCAxKTtcblx0fVxuXG5cdC8vIENoZWNrIHRoZSAnVGFiIFR5cGUnLXNldHRpbmdcblx0aWYgKGVjZmcuc2V0dGluZ3MuaW5kZW50X3N0eWxlICE9PSAnYXV0bycgJiZcblx0XHRhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci50YWJUeXBlJykgIT09ICdhdXRvJykge1xuXHRcdGNvbnN0IHRhYlR5cGUgPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci50YWJUeXBlJyk7XG5cblx0XHRtZXNzYWdlcy5wdXNoKGAqKlRhYiBUeXBlOioqIFlvdSBlZGl0b3IncyBjb25maWd1cmF0aW9uIHNldHRpbmcgXCJUYWIgVHlwZVwiXG5cdFx0KGN1cnJlbnRseSBcIiR7dGFiVHlwZX1cIiBwcmV2ZW50cyB0aGUgZWRpdG9yY29uZmlnLXByb3BlcnR5IFxcYGluZGVudF9zdHlsZVxcYCBmcm9tIHdvcmtpbmcuXG5cdFx0QFwiVGFiIFR5cGVcIiAqKm11c3QqKiBiZSBzZXQgdG8gXCJhdXRvXCIgdG8gZml4IHRoaXMgaXNzdWUuYCk7XG5cblx0XHRzdGF0Y29uID0gTWF0aC5tYXgoc3RhdGNvbiwgNCk7XG5cdH1cblxuXHQvLyBDaGVjayBmb3IgQkxBQ0tMSVNURUQgcGFja2FnZXNcblx0Y29uc3Qgc3VzcGljaXVvdXNQYWNrYWdlcyA9IHt9O1xuXHRsZXQgYWZmZWN0ZWRQcm9wZXJ0aWVzO1xuXHRmb3IgKGNvbnN0IHBhY2thZ2VOYW1lIGluIEJMQUNLTElTVEVEX1BBQ0tBR0VTKSB7XG5cdFx0aWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwoQkxBQ0tMSVNURURfUEFDS0FHRVMsIHBhY2thZ2VOYW1lKSkge1xuXHRcdFx0YWZmZWN0ZWRQcm9wZXJ0aWVzID0gQkxBQ0tMSVNURURfUEFDS0FHRVNbcGFja2FnZU5hbWVdLmZpbHRlcihwcm9wID0+IHtcblx0XHRcdFx0cmV0dXJuIGVjZmcuc2V0dGluZ3NbcHJvcF0gIT09ICdhdXRvJztcblx0XHRcdH0pO1xuXHRcdFx0aWYgKGFmZmVjdGVkUHJvcGVydGllcy5sZW5ndGggPiAwICYmXG5cdFx0XHRcdGF0b20ucGFja2FnZXMuaXNQYWNrYWdlQWN0aXZlKHBhY2thZ2VOYW1lKSkge1xuXHRcdFx0XHRzdXNwaWNpdW91c1BhY2thZ2VzW3BhY2thZ2VOYW1lXSA9IGFmZmVjdGVkUHJvcGVydGllcztcblx0XHRcdH1cblx0XHR9XG5cdH1cblx0aWYgKE9iamVjdC5rZXlzKHN1c3BpY2l1b3VzUGFja2FnZXMpLmxlbmd0aCA+IDApIHtcblx0XHRmb3IgKGNvbnN0IHBhY2thZ2VOYW1lIGluIHN1c3BpY2l1b3VzUGFja2FnZXMpIHtcblx0XHRcdGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN1c3BpY2l1b3VzUGFja2FnZXMsIHBhY2thZ2VOYW1lKSkge1xuXHRcdFx0XHRjb25zdCBwcm9wZXJ0aWVzID0gc3VzcGljaXVvdXNQYWNrYWdlc1twYWNrYWdlTmFtZV07XG5cdFx0XHRcdG1lc3NhZ2VzLnB1c2goYCoqJHtwYWNrYWdlTmFtZX06KiogSXQgaXMgbGlrZWx5IHRoYXQgdGhlXG5cdFx0XHRcdCR7cGFja2FnZU5hbWV9LXBhY2thZ2UgcHJldmVudHMgdGhlIGZvbGxvd2luZ1xuXHRcdFx0XHRwcm9wZXJ0JHtwcm9wZXJ0aWVzLmxlbmd0aCA+IDEgPyAnaWVzJyA6ICd5J30gZnJvbSB3b3JraW5nIHJlbGlhYmx5OlxuXHRcdFx0XHRcXGAke3Byb3BlcnRpZXMuam9pbignYCwgYCcpfVxcYC5AWW91IG1heSBkZWFjdGl2YXRlIG9yIGRpc2FibGUgdGhlICR7cGFja2FnZU5hbWV9LXBhY2thZ2Vcblx0XHRcdFx0dG8gZml4IHRoYXQgaXNzdWUuYCk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHN0YXRjb24gPSBNYXRoLm1heChzdGF0Y29uLCAzKTtcblx0fVxuXG5cdHN3aXRjaCAoc3RhdGNvbikge1xuXHRcdGNhc2UgMTpcblx0XHRcdG1lc3NhZ2VzLnB1c2goYFRoZSBlZGl0b3Jjb25maWcgd2FzIGFwcGxpZWQgc3VjY2Vzc2Z1bGx5IGFuZCB0aGUgZWRpdG9yIGZvciB0aGlzIGZpbGVcblx0XHRcdHNob3VsZCB3b3JrIGFzIGV4cGVjdGVkLiBJZiB5b3UgZmFjZSBhbnkgdW5leHBlY3RlZCBiZWhhdmlvciBwbGVhc2UgcmVwb3J0IHVzIHRoZSBpc3N1ZS5cblx0XHRcdOKZpe+4j2ApO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAwOlxuXHRcdFx0bWVzc2FnZXMucHVzaChgRm9yIHRoaXMgZmlsZSB3ZXJlIG5vIGVkaXRvcmNvbmZpZy1zZXR0aW5ncyBhcHBsaWVkLmApO1xuXHRcdFx0YnJlYWs7XG5cdFx0ZGVmYXVsdDpcblx0XHRcdGJyZWFrO1xuXHR9XG5cblx0Ly8gQXBwbHkgY2hhbmdlc1xuXHRlY2ZnLm1lc3NhZ2VzID0gbWVzc2FnZXM7XG5cdGVjZmcuc3RhdGUgPSBTVEFURVNbc3RhdGNvbl07XG5cdHN0YXR1c1RpbGUoKS51cGRhdGVJY29uKGVjZmcuc3RhdGUpO1xufVxuXG4vLyBJbml0aWFsaXplcyB0aGUgKGludG8gdGhlIFRleHRCdWZmZXItaW5zdGFuY2UpIGVtYmVkZGVkIGVkaXRvcmNvbmZpZy1vYmplY3RcbmZ1bmN0aW9uIGluaXRpYWxpemVUZXh0QnVmZmVyKGJ1ZmZlcikge1xuXHRpZiAoJ2VkaXRvcmNvbmZpZycgaW4gYnVmZmVyID09PSBmYWxzZSkge1xuXHRcdGJ1ZmZlci5lZGl0b3Jjb25maWcgPSB7XG5cdFx0XHRidWZmZXIsIC8vIHByZXNlcnZpbmcgYSByZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBUZXh0QnVmZmVyXG5cdFx0XHRkaXNwb3NhYmxlczogbmV3IChhdG0oKS5Db21wb3NpdGVEaXNwb3NhYmxlKSgpLFxuXHRcdFx0c3RhdGU6ICdzdWJ0bGUnLFxuXHRcdFx0c2V0dGluZ3M6IHtcblx0XHRcdFx0dHJpbV90cmFpbGluZ193aGl0ZXNwYWNlOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdGluc2VydF9maW5hbF9uZXdsaW5lOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdG1heF9saW5lX2xlbmd0aDogJ2F1dG8nLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0XHRlbmRfb2ZfbGluZTogJ2F1dG8nLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0XHRpbmRlbnRfc3R5bGU6ICdhdXRvJywgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHRcdFx0dGFiX3dpZHRoOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdGNoYXJzZXQ6ICdhdXRvJyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0fSxcblxuXHRcdFx0Ly8gU2V0cyB0aGUgZ2l2ZW4gcGFja2FnZSBhY3RpdmUgb3IgaW5hY3RpdmVcblx0XHRcdHNldFBhY2thZ2VTdGF0ZShuYW1lLCBhY3RpdmUpIHtcblx0XHRcdFx0aWYgKGF0b20ucGFja2FnZXMuaXNQYWNrYWdlRGlzYWJsZWQobmFtZSkgPT09IGZhbHNlICYmXG5cdFx0XHRcdFx0YXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VBY3RpdmUobmFtZSkgIT09IGFjdGl2ZSkge1xuXHRcdFx0XHRcdGlmIChhY3RpdmUgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdGF0b20ucGFja2FnZXMuYWN0aXZhdGVQYWNrYWdlKG5hbWUpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRhdG9tLnBhY2thZ2VzLmRlYWN0aXZhdGVQYWNrYWdlKG5hbWUpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fSxcblxuXHRcdFx0Ly8gQXBwbGllcyB0aGUgc2V0dGluZ3MgdG8gdGhlIGJ1ZmZlciBhbmQgdGhlIGNvcnJlc3BvbmRpbmcgZWRpdG9yXG5cdFx0XHRhcHBseVNldHRpbmdzKCkge1xuXHRcdFx0XHRjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuXHRcdFx0XHRcdHJldHVybiAoY3Vyci5nZXRCdWZmZXIoKSA9PT0gYnVmZmVyICYmIGN1cnIpIHx8IHByZXY7XG5cdFx0XHRcdH0sIHVuZGVmaW5lZCk7XG5cdFx0XHRcdGlmICghZWRpdG9yKSB7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29uc3QgY29uZmlnT3B0aW9ucyA9IHtzY29wZTogZWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKX07XG5cdFx0XHRcdGNvbnN0IHNldHRpbmdzID0gdGhpcy5zZXR0aW5ncztcblxuXHRcdFx0XHRpZiAoZWRpdG9yICYmIGVkaXRvci5nZXRCdWZmZXIoKSA9PT0gYnVmZmVyKSB7XG5cdFx0XHRcdFx0aWYgKHNldHRpbmdzLmluZGVudF9zdHlsZSA9PT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0XHRlZGl0b3Iuc2V0U29mdFRhYnMoYXRvbS5jb25maWcuZ2V0KCdlZGl0b3Iuc29mdFRhYnMnLCBjb25maWdPcHRpb25zKSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGVkaXRvci5zZXRTb2Z0VGFicyhzZXR0aW5ncy5pbmRlbnRfc3R5bGUgPT09ICdzcGFjZScpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy50YWJfd2lkdGggPT09ICdhdXRvJykge1xuXHRcdFx0XHRcdFx0ZWRpdG9yLnNldFRhYkxlbmd0aChhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci50YWJMZW5ndGgnLCBjb25maWdPcHRpb25zKSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGVkaXRvci5zZXRUYWJMZW5ndGgoc2V0dGluZ3MudGFiX3dpZHRoKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MuY2hhcnNldCA9PT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0XHRidWZmZXIuc2V0RW5jb2RpbmcoYXRvbS5jb25maWcuZ2V0KCdjb3JlLmZpbGVFbmNvZGluZycsIGNvbmZpZ09wdGlvbnMpKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0YnVmZmVyLnNldEVuY29kaW5nKHNldHRpbmdzLmNoYXJzZXQpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdC8vIG1heF9saW5lX2xlbmd0aC1zZXR0aW5nc1xuXHRcdFx0XHRcdGNvbnN0IGVkaXRvclBhcmFtcyA9IHt9O1xuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGggPT09ICdhdXRvJykge1xuXHRcdFx0XHRcdFx0ZWRpdG9yUGFyYW1zLnNvZnRXcmFwcGVkID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3Iuc29mdFdyYXAnLCBjb25maWdPcHRpb25zKTtcblx0XHRcdFx0XHRcdGVkaXRvclBhcmFtcy5zb2Z0V3JhcEF0UHJlZmVycmVkTGluZUxlbmd0aCA9XG5cdFx0XHRcdFx0XHRcdGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnNvZnRXcmFwQXRQcmVmZXJyZWRMaW5lTGVuZ3RoJywgY29uZmlnT3B0aW9ucyk7XG5cdFx0XHRcdFx0XHRlZGl0b3JQYXJhbXMucHJlZmVycmVkTGluZUxlbmd0aCA9XG5cdFx0XHRcdFx0XHRcdGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnByZWZlcnJlZExpbmVMZW5ndGgnLCBjb25maWdPcHRpb25zKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZWRpdG9yUGFyYW1zLnNvZnRXcmFwcGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGVkaXRvclBhcmFtcy5zb2Z0V3JhcEF0UHJlZmVycmVkTGluZUxlbmd0aCA9IHRydWU7XG5cdFx0XHRcdFx0XHRlZGl0b3JQYXJhbXMucHJlZmVycmVkTGluZUxlbmd0aCA9IHNldHRpbmdzLm1heF9saW5lX2xlbmd0aDtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvLyBVcGRhdGUgdGhlIGVkaXRvci1wcm9wZXJ0aWVzXG5cdFx0XHRcdFx0ZWRpdG9yLnVwZGF0ZShlZGl0b3JQYXJhbXMpO1xuXG5cdFx0XHRcdFx0Ly8gRW5zdXJlIHRoZSB3cmFwLWd1aWRlIGlzIHNldCBwcm9wZXJseVxuXHRcdFx0XHRcdGlmICh0aGlzLndyYXBHdWlkZSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHR0aGlzLndyYXBHdWlkZSA9IG5ldyAod3JhcEd1aWRlKCkpKCk7XG5cdFx0XHRcdFx0XHR0aGlzLndyYXBHdWlkZS5pbml0aWFsaXplKFxuXHRcdFx0XHRcdFx0XHRlZGl0b3IsXG5cdFx0XHRcdFx0XHRcdGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHR0aGlzLndyYXBHdWlkZS51cGRhdGUoKTtcblx0XHRcdFx0XHQvLyBUb2dnbGUgdGhlIHdyYXAtZ3VpZGUgcGFja2FnZSBpZiBuZWNlc3Nhcnlcblx0XHRcdFx0XHR0aGlzLnNldFBhY2thZ2VTdGF0ZSgnd3JhcC1ndWlkZScsIHRoaXMud3JhcEd1aWRlLmlzVmlzaWJsZSgpID09PSBmYWxzZSk7XG5cblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MuZW5kX29mX2xpbmUgIT09ICdhdXRvJykge1xuXHRcdFx0XHRcdFx0YnVmZmVyLnNldFByZWZlcnJlZExpbmVFbmRpbmcoc2V0dGluZ3MuZW5kX29mX2xpbmUpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0XHRzZXRTdGF0ZSh0aGlzKTtcblx0XHRcdH0sXG5cblx0XHRcdC8vIG9uV2lsbFNhdmUtRXZlbnQtSGFuZGxlclxuXHRcdFx0Ly8gVHJpbXMgd2hpdGVzcGFjZXMgYW5kIGluc2VydHMvc3RyaXBzIGZpbmFsIG5ld2xpbmUgYmVmb3JlIHNhdmluZ1xuXHRcdFx0b25XaWxsU2F2ZSgpIHtcblx0XHRcdFx0Y29uc3Qgc2V0dGluZ3MgPSB0aGlzLnNldHRpbmdzO1xuXG5cdFx0XHRcdGlmIChzZXR0aW5ncy50cmltX3RyYWlsaW5nX3doaXRlc3BhY2UgPT09IHRydWUpIHtcblx0XHRcdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LXBhcmFtc1xuXHRcdFx0XHRcdGJ1ZmZlci5iYWNrd2FyZHNTY2FuKC9bIFxcdF0rJC9nbSwgcGFyYW1zID0+IHtcblx0XHRcdFx0XHRcdGlmIChwYXJhbXMubWF0Y2hbMF0ubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0XHRwYXJhbXMucmVwbGFjZSgnJyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoc2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgIT09ICdhdXRvJykge1xuXHRcdFx0XHRcdGNvbnN0IGxhc3RSb3cgPSBidWZmZXIuZ2V0TGluZUNvdW50KCkgLSAxO1xuXG5cdFx0XHRcdFx0aWYgKGJ1ZmZlci5pc1Jvd0JsYW5rKGxhc3RSb3cpKSB7XG5cdFx0XHRcdFx0XHRsZXQgc3RyaXBTdGFydCA9IGJ1ZmZlci5wcmV2aW91c05vbkJsYW5rUm93KGxhc3RSb3cpO1xuXG5cdFx0XHRcdFx0XHRpZiAoc2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdFx0c3RyaXBTdGFydCArPSAxO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0Ly8gU3RyaXAgZW1wdHkgbGluZXMgZnJvbSB0aGUgZW5kXG5cdFx0XHRcdFx0XHRpZiAoc3RyaXBTdGFydCA8IGxhc3RSb3cpIHtcblx0XHRcdFx0XHRcdFx0YnVmZmVyLmRlbGV0ZVJvd3Moc3RyaXBTdGFydCArIDEsIGxhc3RSb3cpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0gZWxzZSBpZiAoc2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdGJ1ZmZlci5hcHBlbmQoJ1xcbicpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH07XG5cblx0XHRidWZmZXIuZWRpdG9yY29uZmlnLmRpc3Bvc2FibGVzLmFkZChcblx0XHRcdGJ1ZmZlci5vbldpbGxTYXZlKGJ1ZmZlci5lZGl0b3Jjb25maWcub25XaWxsU2F2ZS5iaW5kKGJ1ZmZlci5lZGl0b3Jjb25maWcpKVxuXHRcdCk7XG5cdFx0aWYgKGJ1ZmZlci5nZXRVcmkoKSAmJiBidWZmZXIuZ2V0VXJpKCkubWF0Y2goL1tcXFxcfC9dXFwuZWRpdG9yY29uZmlnJC9nKSAhPT0gbnVsbCkge1xuXHRcdFx0YnVmZmVyLmVkaXRvcmNvbmZpZy5kaXNwb3NhYmxlcy5hZGQoXG5cdFx0XHRcdGJ1ZmZlci5vbkRpZFNhdmUocmVhcHBseUVkaXRvcmNvbmZpZylcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG59XG5cbi8vIFJldmVhbCBhbmQgYXBwbHkgdGhlIGVkaXRvcmNvbmZpZyBmb3IgdGhlIGdpdmVuIFRleHRFZGl0b3ItaW5zdGFuY2VcbmZ1bmN0aW9uIG9ic2VydmVUZXh0RWRpdG9yKGVkaXRvcikge1xuXHRpZiAoIWVkaXRvcikge1xuXHRcdHJldHVybjtcblx0fVxuXHRpbml0aWFsaXplVGV4dEJ1ZmZlcihlZGl0b3IuZ2V0QnVmZmVyKCkpO1xuXG5cdGNvbnN0IGZpbGUgPSBlZGl0b3IuZ2V0VVJJKCk7XG5cdGlmICghZmlsZSkge1xuXHRcdGVkaXRvci5vbkRpZFNhdmUoKCkgPT4ge1xuXHRcdFx0b2JzZXJ2ZVRleHRFZGl0b3IoZWRpdG9yKTtcblx0XHR9KTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRlZGl0b3Jjb25maWcoKS5wYXJzZShmaWxlKS50aGVuKGNvbmZpZyA9PiB7XG5cdFx0aWYgKE9iamVjdC5rZXlzKGNvbmZpZykubGVuZ3RoID09PSAwKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgZWNmZyA9IGVkaXRvci5nZXRCdWZmZXIoKS5lZGl0b3Jjb25maWc7XG5cdFx0Y29uc3Qgc2V0dGluZ3MgPSBlY2ZnLnNldHRpbmdzO1xuXHRcdGNvbnN0IGxpbmVFbmRpbmdzID0ge1xuXHRcdFx0Y3JsZjogJ1xcclxcbicsXG5cdFx0XHRjcjogJ1xccicsXG5cdFx0XHRsZjogJ1xcbidcblx0XHR9O1xuXG5cdFx0Ly8gUHJlc2VydmUgZXZhbHVhdGVkIEVkaXRvcmNvbmZpZ1xuXHRcdGVjZmcuY29uZmlnID0gY29uZmlnO1xuXG5cdFx0Ly8gQ2FyZWZ1bGx5IG5vcm1hbGl6ZSBhbmQgaW5pdGlhbGl6ZSBjb25maWctc2V0dGluZ3Ncblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG5cdFx0c2V0dGluZ3MudHJpbV90cmFpbGluZ193aGl0ZXNwYWNlID0gKCd0cmltX3RyYWlsaW5nX3doaXRlc3BhY2UnIGluIGNvbmZpZykgJiZcblx0XHRcdHR5cGVvZiBjb25maWcudHJpbV90cmFpbGluZ193aGl0ZXNwYWNlID09PSAnYm9vbGVhbicgP1xuXHRcdFx0Y29uZmlnLnRyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZSA9PT0gdHJ1ZSA6XG5cdFx0XHQnYXV0byc7XG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG5cdFx0c2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPSAoJ2luc2VydF9maW5hbF9uZXdsaW5lJyBpbiBjb25maWcpICYmXG5cdFx0XHR0eXBlb2YgY29uZmlnLmluc2VydF9maW5hbF9uZXdsaW5lID09PSAnYm9vbGVhbicgP1xuXHRcdFx0Y29uZmlnLmluc2VydF9maW5hbF9uZXdsaW5lID09PSB0cnVlIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy5pbmRlbnRfc3R5bGUgPSAoKCdpbmRlbnRfc3R5bGUnIGluIGNvbmZpZykgJiZcblx0XHRcdGNvbmZpZy5pbmRlbnRfc3R5bGUuc2VhcmNoKC9eKHNwYWNlfHRhYikkLykgPiAtMSkgP1xuXHRcdFx0Y29uZmlnLmluZGVudF9zdHlsZSA6XG5cdFx0XHQnYXV0byc7XG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG5cdFx0c2V0dGluZ3MuZW5kX29mX2xpbmUgPSBsaW5lRW5kaW5nc1tjb25maWcuZW5kX29mX2xpbmVdIHx8ICdhdXRvJztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy50YWJfd2lkdGggPSBwYXJzZUludChjb25maWcuaW5kZW50X3NpemUgfHwgY29uZmlnLnRhYl93aWR0aCwgMTApO1xuXHRcdGlmIChpc05hTihzZXR0aW5ncy50YWJfd2lkdGgpIHx8IHNldHRpbmdzLnRhYl93aWR0aCA8PSAwKSB7XG5cdFx0XHRzZXR0aW5ncy50YWJfd2lkdGggPSAnYXV0byc7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0fVxuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuXHRcdHNldHRpbmdzLm1heF9saW5lX2xlbmd0aCA9IHBhcnNlSW50KGNvbmZpZy5tYXhfbGluZV9sZW5ndGgsIDEwKTtcblx0XHRpZiAoaXNOYU4oc2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoKSB8fCBzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGggPD0gMCkge1xuXHRcdFx0c2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoID0gJ2F1dG8nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdH1cblxuXHRcdHNldHRpbmdzLmNoYXJzZXQgPSAoJ2NoYXJzZXQnIGluIGNvbmZpZykgP1xuXHRcdFx0Y29uZmlnLmNoYXJzZXQucmVwbGFjZSgvLS9nLCAnJykudG9Mb3dlckNhc2UoKSA6XG5cdFx0XHQnYXV0byc7XG5cblx0XHRlY2ZnLmFwcGx5U2V0dGluZ3MoKTtcblx0fSkuY2F0Y2goRXJyb3IsIGUgPT4ge1xuXHRcdGNvbnNvbGUud2FybihgYXRvbS1lZGl0b3Jjb25maWc6ICR7ZX1gKTtcblx0fSk7XG59XG5cbi8vIFJlYXBwbGllcyB0aGUgd2hvbGUgZWRpdG9yY29uZmlnIHRvICoqYWxsKiogb3BlbiBUZXh0RWRpdG9yLWluc3RhbmNlc1xuZnVuY3Rpb24gcmVhcHBseUVkaXRvcmNvbmZpZygpIHtcblx0Y29uc3QgdGV4dEVkaXRvcnMgPSBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpO1xuXHR0ZXh0RWRpdG9ycy5mb3JFYWNoKGVkaXRvciA9PiB7XG5cdFx0b2JzZXJ2ZVRleHRFZGl0b3IoZWRpdG9yKTtcblx0fSk7XG59XG5cbi8vIFJlYXBwbGllcyB0aGUgc2V0dGluZ3MgaW1tZWRpYXRlbHkgYWZ0ZXIgY2hhbmdpbmcgdGhlIGZvY3VzIHRvIGEgbmV3IHBhbmVcbmZ1bmN0aW9uIG9ic2VydmVBY3RpdmVQYW5lSXRlbShlZGl0b3IpIHtcblx0aWYgKGVkaXRvciAmJiBlZGl0b3IuY29uc3RydWN0b3IubmFtZSA9PT0gJ1RleHRFZGl0b3InKSB7XG5cdFx0aWYgKGVkaXRvci5nZXRCdWZmZXIoKS5lZGl0b3Jjb25maWcpIHtcblx0XHRcdGVkaXRvci5nZXRCdWZmZXIoKS5lZGl0b3Jjb25maWcuYXBwbHlTZXR0aW5ncygpO1xuXHRcdH1cblx0fSBlbHNlIHtcblx0XHRzdGF0dXNUaWxlKCkucmVtb3ZlSWNvbigpO1xuXHR9XG59XG5cbi8vIEhvb2sgaW50byB0aGUgZXZlbnRzIHRvIHJlY29nbml6ZSB0aGUgdXNlciBvcGVuaW5nIG5ldyBlZGl0b3JzIG9yIGNoYW5naW5nIHRoZSBwYW5lXG5jb25zdCBhY3RpdmF0ZSA9ICgpID0+IHtcblx0Z2VuZXJhdGVDb25maWcoKTtcblx0c2hvd1N0YXRlKCk7XG5cdGZpeEZpbGUoKTtcblx0YXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKG9ic2VydmVUZXh0RWRpdG9yKTtcblx0YXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKG9ic2VydmVBY3RpdmVQYW5lSXRlbSk7XG59O1xuXG4vLyBDbGVhbiB0aGUgc3RhdHVzLWljb24gdXAsIHJlbW92ZSBhbGwgZW1iZWRkZWQgZWRpdG9yY29uZmlnLW9iamVjdHNcbmNvbnN0IGRlYWN0aXZhdGUgPSAoKSA9PiB7XG5cdGNvbnN0IHRleHRFZGl0b3JzID0gYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKTtcblx0dGV4dEVkaXRvcnMuZm9yRWFjaChlZGl0b3IgPT4ge1xuXHRcdGVkaXRvci5nZXRCdWZmZXIoKS5lZGl0b3Jjb25maWcuZGlzcG9zYWJsZXMuZGlzcG9zZSgpO1xuXHR9KTtcblx0c3RhdHVzVGlsZSgpLnJlbW92ZUljb24oKTtcbn07XG5cbi8vIEFwcGx5IHRoZSBzdGF0dXNiYXIgaWNvbi1jb250YWluZXJcbi8vIFRoZSBpY29uIHdpbGwgYmUgYXBwbGllZCBpZiBuZWVkZWRcbmNvbnN0IGNvbnN1bWVTdGF0dXNCYXIgPSBzdGF0dXNCYXIgPT4ge1xuXHRpZiAoc3RhdHVzVGlsZSgpLmNvbnRhaW5lckV4aXN0cygpID09PSBmYWxzZSkge1xuXHRcdHN0YXR1c0Jhci5hZGRSaWdodFRpbGUoe1xuXHRcdFx0aXRlbTogc3RhdHVzVGlsZSgpLmNyZWF0ZUNvbnRhaW5lcigpLFxuXHRcdFx0cHJpb3JpdHk6IDk5OVxuXHRcdH0pO1xuXHR9XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7YWN0aXZhdGUsIGRlYWN0aXZhdGUsIGNvbnN1bWVTdGF0dXNCYXJ9O1xuIl19